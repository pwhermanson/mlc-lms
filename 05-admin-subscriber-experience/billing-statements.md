# Billing Statements

## Purpose

This specification defines the billing statement management interface for subscriber administrators in the MLC-LMS platform. It provides comprehensive tools for viewing, generating, and managing billing statements, enabling administrators to maintain accurate financial records, reconcile billing periods, and provide documentation for accounting and audit purposes.

The billing statement interface serves as the central hub for all billing-related information, allowing administrators to access current billing status, generate custom statements, view payment history, and manage billing preferences for their organization.

## Scope

### Included
- Current billing status and subscription overview
- Statement generation and customization tools
- Payment history and transaction details
- Billing preferences and settings management
- Integration with on-demand statement generation
- School-specific billing features (PO numbers, institutional formatting)
- Billing alerts and notifications
- Payment method management
- Billing cycle management and changes

### Excluded
- On-demand statement generation functionality (see [billing-statements-on-demand.md](../14-payments-and-subscriptions/billing-statements-on-demand.md))
- Payment processing and checkout flows (see [checkout-and-trials.md](../14-payments-and-subscriptions/checkout-and-trials.md))
- Subscription plan management (see [plans-and-pricing.md](../14-payments-and-subscriptions/plans-and-pricing.md))
- Seat management operations (see [seat-management.md](../14-payments-and-subscriptions/seat-management.md))
- Promotional code management (see [promo-codes.md](../14-payments-and-subscriptions/promo-codes.md))

## Data Model

### Core Entities

#### Billing Statement
- `statement_id` (UUID, Primary Key)
- `subscription_id` (UUID, Foreign Key)
- `statement_type` (enum: monthly, quarterly, annual, custom, on_demand)
- `period_start` (date)
- `period_end` (date)
- `generated_at` (timestamp)
- `generated_by` (UUID, Foreign Key)
- `status` (enum: draft, generated, sent, archived)
- `total_amount` (decimal)
- `paid_amount` (decimal)
- `outstanding_balance` (decimal)
- `statement_number` (string, unique)
- `po_number` (string, nullable)
- `metadata` (JSON, for additional statement properties)

#### Billing Transaction
- `transaction_id` (UUID, Primary Key)
- `statement_id` (UUID, Foreign Key)
- `transaction_type` (enum: subscription, seat_addition, seat_removal, proration, credit, refund, payment)
- `description` (string)
- `amount` (decimal)
- `quantity` (integer, nullable)
- `unit_price` (decimal, nullable)
- `transaction_date` (date)
- `billing_period` (string)
- `reference_id` (string, nullable)
- `metadata` (JSON, for additional transaction data)

#### Payment Record
- `payment_id` (UUID, Primary Key)
- `statement_id` (UUID, Foreign Key)
- `payment_method` (enum: credit_card, bank_transfer, check, po, other)
- `payment_amount` (decimal)
- `payment_date` (date)
- `payment_reference` (string, nullable)
- `status` (enum: pending, completed, failed, refunded)
- `processed_by` (string, nullable)
- `notes` (text, nullable)

### Relationships
- One subscription has many billing statements
- One billing statement belongs to one subscription
- One billing statement has many billing transactions
- One billing statement has many payment records
- One billing statement can be generated by one user
- One user can generate many billing statements

## Behavior and Rules

### Statement Generation Rules

#### Automatic Statement Generation
- **Monthly Statements**: Generated automatically on the 1st of each month for the previous month
- **Annual Statements**: Generated on the anniversary date of the subscription
- **Quarterly Statements**: Generated every 3 months for school customers
- **Custom Statements**: Generated on-demand for any date range

#### Statement Content Rules
- **Transaction Inclusion**: All transactions within the specified period must be included
- **Proration Handling**: Mid-cycle changes must show prorated amounts
- **Tax Calculations**: Include applicable taxes based on subscriber location
- **PO Integration**: Include purchase order numbers for school customers
- **Payment Matching**: Match payments to corresponding charges

#### Statement Status Transitions
```
[Draft] → [Generated] → [Sent] → [Archived]
    ↓         ↓           ↓
[Failed] ← [Error] ← [Failed]
```

### Billing Cycle Management

#### Cycle Change Rules
- **Monthly to Annual**: Can be changed at any time with immediate proration
- **Annual to Monthly**: Can only be changed at the end of the annual period
- **Proration**: All cycle changes must include accurate proration calculations
- **Notification**: Subscribers must be notified of billing cycle changes

#### Payment Method Rules
- **Primary Method**: One primary payment method per subscription
- **Backup Methods**: Multiple backup payment methods allowed
- **Validation**: All payment methods must be validated before use
- **Expiration**: Expired payment methods must be updated before next billing

### School-Specific Rules

#### Purchase Order Integration
- **PO Required**: School customers must provide PO numbers for annual billing
- **PO Validation**: PO numbers must be validated against school systems
- **PO Tracking**: Track PO approval status and dates
- **Compliance**: Generate compliance reports for school audits

#### Institutional Billing
- **Department Breakdown**: Separate billing by department or program
- **Budget Codes**: Include school budget codes and classifications
- **Approval Workflows**: Multi-level approval for billing changes
- **District Consolidation**: Combine billing from multiple schools

## UX Requirements

### Billing Dashboard

#### Overview Section
- **Current Status**: Display current subscription status and next billing date
- **Outstanding Balance**: Show any outstanding amounts due
- **Recent Activity**: List recent transactions and payments
- **Quick Actions**: Generate statement, update payment method, view history
- **Alerts**: Display billing alerts and notifications

#### Statement Management Interface
- **Statement List**: Table view of all statements with filtering and sorting
- **Statement Details**: Detailed view of individual statements
- **Generation Tools**: Interface for generating custom statements
- **Download Options**: PDF and CSV download options
- **Email Delivery**: Send statements via email to multiple recipients

#### Payment Management
- **Payment History**: Chronological list of all payments
- **Payment Methods**: Manage credit cards and bank accounts
- **Scheduled Payments**: View and manage recurring payments
- **Payment Alerts**: Notifications for failed or upcoming payments

### Key States and Interactions

#### Statement Generation
1. **Date Selection**: Choose statement period with date picker
2. **Format Selection**: Select PDF or CSV format
3. **Customization**: Choose which data to include
4. **Preview**: Review statement before generation
5. **Generation**: Process statement with progress indicator
6. **Delivery**: Download or email generated statement

#### Payment Processing
1. **Payment Method Selection**: Choose from available payment methods
2. **Amount Confirmation**: Review payment amount and details
3. **Processing**: Show payment processing status
4. **Confirmation**: Display payment confirmation and receipt
5. **Statement Update**: Update statement with payment information

#### Billing Cycle Changes
1. **Current Cycle Display**: Show current billing cycle information
2. **Change Options**: Present available billing cycle options
3. **Proration Preview**: Show prorated amounts and effective dates
4. **Confirmation**: Review changes before applying
5. **Notification**: Send confirmation of billing cycle changes

### Accessibility Requirements

#### Keyboard Navigation
- All billing functions accessible via keyboard
- Tab order follows logical workflow
- Focus indicators clearly visible
- Keyboard shortcuts for common actions

#### Screen Reader Support
- Semantic HTML structure for billing data
- ARIA labels for complex financial tables
- Status announcements for payment processing
- Alternative text for financial charts and graphs

#### Visual Design
- High contrast ratios for financial data
- Color coding supplemented with text labels
- Clear visual hierarchy for billing information
- Responsive design for mobile access

## Telemetry

### Billing Statement Events

#### Statement Operations
- `statement_viewed`
  - `statement_id`, `subscription_id`, `viewed_by`, `view_type`
- `statement_generated`
  - `statement_id`, `subscription_id`, `generated_by`, `statement_type`, `period`
- `statement_downloaded`
  - `statement_id`, `subscription_id`, `downloaded_by`, `format`
- `statement_emailed`
  - `statement_id`, `subscription_id`, `emailed_by`, `recipient_count`

#### Payment Events
- `payment_method_updated`
  - `subscription_id`, `updated_by`, `payment_method_type`
- `payment_processed`
  - `payment_id`, `subscription_id`, `amount`, `payment_method`, `status`
- `billing_cycle_changed`
  - `subscription_id`, `old_cycle`, `new_cycle`, `changed_by`

#### Billing Management Events
- `billing_preferences_updated`
  - `subscription_id`, `updated_by`, `preferences_changed[]`
- `billing_alert_acknowledged`
  - `alert_id`, `subscription_id`, `acknowledged_by`
- `po_number_updated`
  - `subscription_id`, `po_number`, `updated_by`

### Performance Metrics
- Statement generation time
- Payment processing time
- Dashboard load time
- Statement download time
- Email delivery time

## Permissions

### Subscriber Administrators
- **Full Access**: All billing statement management functions
- **Statement Generation**: Generate custom statements for any date range
- **Payment Management**: Update payment methods and process payments
- **Billing Settings**: Modify billing preferences and cycle settings
- **PO Management**: Update and manage purchase order information
- **User Access**: Grant billing access to other organization members

### Teacher-Admin (Ensemble Plans)
- **Statement Viewing**: View billing statements for their organization
- **Payment History**: Access payment history and transaction details
- **Limited Settings**: Update basic billing preferences (if enabled)
- **Restrictions**: Cannot modify payment methods or billing cycles

### Teachers
- **Read-Only Access**: View current billing status and recent statements
- **Payment History**: Access their individual payment history
- **Restrictions**: Cannot modify any billing settings or generate statements

### System Administrators
- **Override Access**: Override all billing rules and limitations
- **Emergency Operations**: Perform emergency billing operations
- **Audit Access**: Full access to all billing logs and history
- **Support Operations**: Assist with billing issues and disputes

### Read-Only Access
- **Statement Viewing**: View billing statements and payment history
- **Status Information**: Access current billing status and subscription details
- **Restrictions**: Cannot modify any billing settings or generate statements

## Dependencies

### Internal Dependencies
- [billing-statements-on-demand.md](../14-payments-and-subscriptions/billing-statements-on-demand.md) - On-demand statement generation functionality
- [billing-plans-and-seats.md](../14-payments-and-subscriptions/billing-plans-and-seats.md) - Core billing data and transaction history
- [plans-and-pricing.md](../14-payments-and-subscriptions/plans-and-pricing.md) - Subscription plans and pricing structure
- [seat-management.md](../14-payments-and-subscriptions/seat-management.md) - Seat management and billing calculations
- [po-and-invoicing-for-schools.md](../14-payments-and-subscriptions/po-and-invoicing-for-schools.md) - Purchase order integration for schools

### External Dependencies
- **Payment Processor**: For payment processing and transaction management
- **Email Service**: For statement delivery and billing notifications
- **PDF Generation Service**: For statement document generation
- **Audit System**: For billing operation logging and compliance
- **Database**: For billing data persistence and queries

### Integration Points
- **Billing API**: Real-time integration with billing system
- **Payment Gateway**: Integration with payment processing services
- **Email Service**: Integration with email delivery system
- **Document Storage**: Integration with document storage service
- **Notification Service**: Integration with user notification system

## Open Questions

1. **Statement Retention Policy**: What is the required retention period for billing statements, and how should old statements be archived or purged?

2. **International Billing**: What additional requirements exist for international customers regarding currency, tax calculations, and compliance?

3. **Billing Disputes**: What process should be in place for handling billing disputes and chargebacks?

4. **Automated Billing Alerts**: What automated alerts should be sent for billing issues, payment failures, or unusual activity?

5. **Billing Analytics**: What level of billing analytics and reporting should be provided to help administrators understand spending patterns?

6. **Multi-Currency Support**: How should the system handle multiple currencies for international customers?

7. **Billing API Access**: Should there be API endpoints for programmatic access to billing data and statement generation?

8. **Mobile Billing Access**: What billing functions should be available in mobile applications?

9. **Billing Integration**: What third-party integrations are needed for accounting software, ERP systems, or other business tools?

10. **Billing Compliance**: What compliance requirements exist for financial data handling and reporting?

